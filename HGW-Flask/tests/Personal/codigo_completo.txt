===== F:\HGW-Sena\HGW-Flask\tests\Personal\Header\test_header.py ===== 
import pytest

DIR = "app.controllers.User.Personal.Info_Header"

# -------------------------------------------------------
# 1. FALTA ID DE USUARIO
# -------------------------------------------------------
def test_header_sin_id(client):
    resp = client.get("/api/header")
    assert resp.status_code == 400

    data = resp.get_json()
    assert data["success"] is False
    assert "ID de usuario" in data["message"]


# -------------------------------------------------------
# 2. USUARIO NO EXISTE
# -------------------------------------------------------
def test_header_usuario_no_existe(monkeypatch, client, fake_conn):
    
    # fetchone → None en consulta del usuario
    fake_conn.set_fetchone_responses([
        None
    ])
    fake_conn.set_fetchall_responses([])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/header?id=5")

    assert resp.status_code == 404
    assert resp.get_json()["message"] == "Usuario no encontrado"


# -------------------------------------------------------
# 3. USUARIO INACTIVO
# -------------------------------------------------------
def test_header_usuario_inactivo(monkeypatch, client, fake_conn):

    fake_conn.set_fetchone_responses([
        {"url_foto_perfil": "image.jpg", "activo": 0}
    ])
    fake_conn.set_fetchall_responses([])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/header?id=10")

    assert resp.status_code == 403
    assert "desactivada" in resp.get_json()["message"].lower()


# -------------------------------------------------------
# 4. HEADER EXITOSO (carrito suma correctamente)
# -------------------------------------------------------
def test_header_exitoso(monkeypatch, client, fake_conn):

    # 1) Primero fetchone() trae la info del usuario
    # 2) Segundo fetchone() trae el total del carrito
    fake_conn.set_fetchone_responses([
        {"url_foto_perfil": "foto.jpg", "activo": 1},   # usuario
        {"total_carrito": 4}                            # carrito
    ])
    fake_conn.set_fetchall_responses([])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/header?id=1")

    assert resp.status_code == 200
    data = resp.get_json()

    assert data["success"] is True
    assert data["user"]["total_carrito"] == 4
    assert data["user"]["url_foto_perfil"] == "foto.jpg"


# -------------------------------------------------------
# 5. ERROR INTERNO (Excepción en cursor)
# -------------------------------------------------------
def test_header_error(monkeypatch, client):

    class FakeConn:
        def cursor(self):
            raise Exception("DB rota")

    monkeypatch.setattr(f"{DIR}.get_db", lambda: FakeConn())

    resp = client.get("/api/header?id=1")

    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Direcciones\test_crear_direccion.py ===== 
import pytest

DIR = "app.controllers.User.Personal.personal"

def test_crear_direccion_exitoso(monkeypatch, client, fake_conn):
    data = {
        "id_usuario": 1,
        "lugar_entrega": "Casa",
        "direccion": "Calle 10",
        "ciudad": "Bogotá",
        "pais": "Colombia",
        "codigo_postal": "110111"
    }

    # Respuesta del SELECT de ubicaciones
    fake_conn.set_fetchone_responses([
        {"id_ubicacion": 99}
    ])

    # Mock DB
    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    fake_conn.lastrowid = 123  # para el INSERT

    resp = client.post("/api/direcciones/crear", json=data)

    assert resp.status_code == 201
    json_data = resp.get_json()
    assert json_data["success"] is True
    assert json_data["id_direccion"] == 123
    assert fake_conn.commit_count == 1


def test_crear_direccion_ciudad_invalida(monkeypatch, client, fake_conn):
    data = {
        "id_usuario": 1,
        "lugar_entrega": "Casa",
        "direccion": "Calle 10",
        "ciudad": "X",
        "pais": "Y",
        "codigo_postal": "110111"
    }

    fake_conn.set_fetchone_responses([None])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.post("/api/direcciones/crear", json=data)
    assert resp.status_code == 400
    assert resp.get_json()["success"] is False


def test_crear_direccion_error_db(monkeypatch, client):
    def fake_error():
        raise Exception("DB caída")

    monkeypatch.setattr(f"{DIR}.get_db", fake_error)

    data = {
        "id_usuario": 1,
        "lugar_entrega": "Casa",
        "direccion": "Calle 10",
        "ciudad": "Bogotá",
        "pais": "Colombia",
        "codigo_postal": "110111"
    }

    resp = client.post("/api/direcciones/crear", json=data)

    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Direcciones\test_eliminar_direccion.py ===== 
import pytest

DIR = "app.controllers.User.Personal.personal"

def test_eliminar_direccion_exitoso(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([
        {"id_direccion": 5}  # la dirección existe
    ])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    data = {"id_direccion": 5, "id_usuario": 1}

    resp = client.delete("/api/direcciones/eliminar", json=data)

    assert resp.status_code == 200
    assert resp.get_json()["success"] is True
    assert fake_conn.commit_count == 1


def test_eliminar_direccion_no_encontrada(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([None])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    data = {"id_direccion": 5, "id_usuario": 1}

    resp = client.delete("/api/direcciones/eliminar", json=data)

    assert resp.status_code == 404
    assert resp.get_json()["success"] is False


def test_eliminar_direccion_datos_incompletos(client):
    resp = client.delete("/api/direcciones/eliminar", json={})
    assert resp.status_code == 400


def test_eliminar_direccion_error(monkeypatch, client):
    monkeypatch.setattr(
        f"{DIR}.get_db",
        lambda: (_ for _ in ()).throw(Exception("DB caída"))
    )

    data = {"id_direccion": 5, "id_usuario": 1}

    resp = client.delete("/api/direcciones/eliminar", json=data)

    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Direcciones\test_get_direcciones.py ===== 
import pytest

DIR = "app.controllers.User.Personal.personal"

def test_get_direcciones_exitoso(monkeypatch, client, fake_conn):
    fake_conn.set_fetchall_responses([
        [
            {
                "id": 1,
                "direccion": "Calle 10",
                "codigo_postal": "110111",
                "lugar_entrega": "Casa",
                "ciudad": "Bogotá",
                "pais": "Colombia"
            }
        ]
    ])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/direcciones?id=1")

    assert resp.status_code == 200
    json_data = resp.get_json()
    assert json_data["success"] is True
    assert len(json_data["direcciones"]) == 1


def test_get_direcciones_sin_id(client):
    resp = client.get("/api/direcciones")
    assert resp.status_code == 400


def test_get_direcciones_error(monkeypatch, client):
    monkeypatch.setattr(
        f"{DIR}.get_db",
        lambda: (_ for _ in ()).throw(Exception("DB caída"))
    )

    resp = client.get("/api/direcciones?id=1")

    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Info\test_cambiar_contrasena.py ===== 
import pytest

DIR = "app.controllers.User.Personal.personal"

def test_cambiar_contrasena_incompleto(client):
    resp = client.post("/api/cambiar-contrasena", json={})
    assert resp.status_code == 400


def test_cambiar_contrasena_usuario_no_existe(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([None])
    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    data = {"id_usuario": 1, "actual": "123", "nueva": "456"}
    resp = client.post("/api/cambiar-contrasena", json=data)

    assert resp.status_code == 404


def test_cambiar_contrasena_incorrecta(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([{"pss": "hashed_pass"}])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    monkeypatch.setattr(
        f"{DIR}.bcrypt.check_password_hash",
        lambda stored, given: False
    )

    data = {"id_usuario": 1, "actual": "wrong", "nueva": "456"}
    resp = client.post("/api/cambiar-contrasena", json=data)

    assert resp.status_code == 401


def test_cambiar_contrasena_exitoso(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([{"pss": "hashed"}])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    monkeypatch.setattr(
        f"{DIR}.bcrypt.check_password_hash",
        lambda stored, given: True
    )

    monkeypatch.setattr(
        f"{DIR}.bcrypt.generate_password_hash",
        lambda pwd: b"new_hashed"
    )

    data = {"id_usuario": 1, "actual": "123", "nueva": "456"}
    resp = client.post("/api/cambiar-contrasena", json=data)

    assert resp.status_code == 200
    assert fake_conn.commit_count == 1


def test_cambiar_contrasena_error(monkeypatch, client):
    monkeypatch.setattr(
        f"{DIR}.get_db",
        lambda: (_ for _ in ()).throw(Exception("DB caída"))
    )

    resp = client.post("/api/cambiar-contrasena", json={"id_usuario": 1, "actual": "x", "nueva": "y"})
    assert resp.status_code == 500
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Info\test_delete_foto_perfil.py ===== 
import pytest
import os

DIR = "app.controllers.User.Personal.personal"


def test_delete_foto_sin_id(client):
    resp = client.delete("/api/personal/delete")
    assert resp.status_code == 400


def test_delete_foto_no_existe(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([None])
    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.delete("/api/personal/delete?id=1")

    assert resp.status_code == 404


def test_delete_foto_exitoso(monkeypatch, client, fake_conn, tmp_path):
    # Mock DB
    fake_conn.set_fetchone_responses([
        {"url_foto_perfil": "static/uploads/profile_pictures/foto.png"}
    ])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    # Crear archivo simulado
    fake_file = tmp_path / "foto.png"
    fake_file.write_text("demo")

    # Mock ruta absoluta
    monkeypatch.setattr(
        f"{DIR}.os.path.exists",
        lambda path: True
    )
    monkeypatch.setattr(
        f"{DIR}.os.remove",
        lambda path: None
    )

    resp = client.delete("/api/personal/delete?id=1")

    assert resp.status_code == 200
    assert resp.get_json()["success"] is True


def test_delete_foto_error(monkeypatch, client):
    monkeypatch.setattr(
        f"{DIR}.get_db",
        lambda: (_ for _ in ()).throw(Exception("DB caída"))
    )

    resp = client.delete("/api/personal/delete?id=1")

    assert resp.status_code == 500
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Info\test_get_personal.py ===== 
import pytest
from decimal import Decimal

DIR = "app.controllers.User.Personal.personal"

def test_get_personal_exitoso(monkeypatch, client, fake_conn):
    # 1) SELECT usuario
    fake_conn.set_fetchone_responses([
        {
            "id_usuario": 1,
            "nombre": "Fabian",
            "apellido": "Amaya",
            "nombre_usuario": "fabian",
            "pss": "hashed",
            "correo_electronico": "f@f.com",
            "numero_telefono": "123",
            "url_foto_perfil": None,
            "patrocinador": None,
            "bv_acumulados": Decimal("100"),
            "nombre_medio": "Nequi"
        },
        # 3) SELECT membresía
        {
            "membresia": 1,
            "nombre_membresia": "Bronce",
            "bv_requeridos": Decimal("200"),
            "precio_membresia": Decimal("50000"),
            "bv_acumulados": Decimal("100"),
            "proxima_membresia": "Plata"
        }
    ])

    # 2) fetchall → direcciones
    fake_conn.set_fetchall_responses([
        [  # Direcciones
            {
                "id_direccion": 1,
                "direccion": "Calle 10",
                "codigo_postal": "110111",
                "lugar_entrega": "Casa",
                "ciudad_id": 10,
                "pais_id": 20,
                "ciudad": "Bogotá",
                "pais": "Colombia"
            }
        ],
        [  # historial BV
            {
                "bv_ganados": 10,
                "fecha_transaccion": "2024-10-01",
                "descripcion": "Compra"
            }
        ]
    ])

    # Mock DB
    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/personal?id=1")

    assert resp.status_code == 200
    json_data = resp.get_json()
    assert json_data["success"] is True
    assert json_data["usuario"]["nombre"] == "Fabian"
    assert len(json_data["usuario"]["direcciones"]) == 1


def test_get_personal_sin_id(client):
    resp = client.get("/api/personal")
    assert resp.status_code == 400


def test_get_personal_no_existe(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([None])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/personal?id=99")

    assert resp.status_code == 404


def test_get_personal_error(monkeypatch, client):
    monkeypatch.setattr(
        f"{DIR}.get_db",
        lambda: (_ for _ in ()).throw(Exception("DB caída"))
    )

    resp = client.get("/api/personal?id=1")

    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Info\test_update_personal.py ===== 
import pytest
import json

DIR = "app.controllers.User.Personal.personal"

def test_update_personal_json_exitoso(monkeypatch, client, fake_conn):
    data = {
        "nombre": "Fabian Nuevo",
        "apellido": "Amaya",
        "direcciones": [
            {
                "id_direccion": 1,
                "direccion": "Nueva Calle",
                "codigo_postal": "99999"
            }
        ]
    }

    fake_conn.set_fetchone_responses([{"id_usuario": 1}])
    fake_conn.set_fetchall_responses([])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.put(
        "/api/personal/update?id=1",
        data=json.dumps(data),
        content_type="application/json"
    )

    assert resp.status_code == 200
    assert resp.get_json()["success"] is True
    assert fake_conn.commit_count == 1


def test_update_personal_sin_id(client):
    resp = client.put("/api/personal/update")
    assert resp.status_code == 400


def test_update_personal_usuario_no_existe(monkeypatch, client, fake_conn):
    fake_conn.set_fetchone_responses([None])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    # simulamos foto (multipart)
    resp = client.put(
        "/api/personal/update?id=1",
        data={"data": "{}"},
        content_type="multipart/form-data"
    )

    assert resp.status_code == 404


def test_update_personal_error(monkeypatch, client):
    monkeypatch.setattr(
        f"{DIR}.get_db",
        lambda: (_ for _ in ()).throw(Exception("DB caída"))
    )

    resp = client.put("/api/personal/update?id=1")

    assert resp.status_code == 500
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\InfoPersonal\Ubicaciones\test_get_ubicaciones.py ===== 
import pytest

DIR = "app.controllers.User.Personal.personal"

def test_get_ubicaciones_exitoso(monkeypatch, client, fake_conn):
    """
    Caso exitoso: debe retornar países y sus ciudades.
    """

    # Respuestas simuladas:
    # Primera consulta → países
    # Las siguientes consultas → ciudades de cada país
    fake_conn.set_fetchall_responses([
        [  # países
            {"id_ubicacion": 1, "nombre": "Colombia"},
            {"id_ubicacion": 2, "nombre": "México"}
        ],
        [  # ciudades de Colombia
            {"id_ubicacion": 10, "nombre": "Bogotá"},
            {"id_ubicacion": 11, "nombre": "Medellín"}
        ],
        [  # ciudades de México
            {"id_ubicacion": 20, "nombre": "CDMX"},
            {"id_ubicacion": 21, "nombre": "Guadalajara"}
        ]
    ])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/ubicaciones")
    assert resp.status_code == 200

    data = resp.get_json()
    assert data["success"] is True

    ubic = data["ubicaciones"]

    assert "Colombia" in ubic
    assert "México" in ubic
    assert ubic["Colombia"] == ["Bogotá", "Medellín"]
    assert ubic["México"] == ["CDMX", "Guadalajara"]


def test_get_ubicaciones_sin_ciudades(monkeypatch, client, fake_conn):
    """
    Caso donde el país existe pero no tiene ciudades asociadas.
    """

    fake_conn.set_fetchall_responses([
        [  # países
            {"id_ubicacion": 1, "nombre": "Colombia"}
        ],
        [  # ciudades vacías
        ]
    ])

    monkeypatch.setattr(f"{DIR}.get_db", lambda: fake_conn)

    resp = client.get("/api/ubicaciones")
    assert resp.status_code == 200

    data = resp.get_json()
    assert data["ubicaciones"]["Colombia"] == []


def test_get_ubicaciones_error(monkeypatch, client):
    """
    Error en base de datos.
    """

    monkeypatch.setattr(
        f"{DIR}.get_db",
        lambda: (_ for _ in ()).throw(Exception("DB caída"))
    )

    resp = client.get("/api/ubicaciones")

    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\Membresia\test_obtener_membresia.py ===== 
import pytest
from decimal import Decimal

# ================================
# GET /api/membresia?id=#
# ================================

def test_obtener_membresia_sin_id(client):
    resp = client.get("/api/membresia")  
    assert resp.status_code == 400
    assert resp.get_json()["success"] is False


def test_obtener_membresia_no_existe(monkeypatch, client, fake_conn):

    fake_conn.set_fetchone_responses([None])

    monkeypatch.setattr(
        "app.controllers.User.Personal.membresia.get_db",
        lambda: fake_conn
    )

    resp = client.get("/api/membresia?id=5")
    assert resp.status_code == 404
    assert resp.get_json()["success"] is False


def test_obtener_membresia_exitoso(monkeypatch, client, fake_conn):

    fake_conn.set_fetchone_responses([
        {
            "id_membresia": 1,
            "nombre_membresia": "Bronce",
            "precio_membresia": Decimal("20.5"),
            "bv_requeridos": Decimal("100.0"),
            "bv_acumulados": Decimal("50.0"),
            "proxima_membresia": "Plata"
        }
    ])

    monkeypatch.setattr(
        "app.controllers.User.Personal.membresia.get_db",
        lambda: fake_conn
    )

    resp = client.get("/api/membresia?id=1")
    body = resp.get_json()

    assert resp.status_code == 200
    assert body["success"] is True
    assert body["membresia"]["nombre_membresia"] == "Bronce"
    assert isinstance(body["membresia"]["precio_membresia"], float)


def test_obtener_membresia_error(monkeypatch, client):

    def fake_error():
        raise Exception("DB caída")

    monkeypatch.setattr(
        "app.controllers.User.Personal.membresia.get_db",
        fake_error
    )

    resp = client.get("/api/membresia?id=1")
    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\Membresia\test_obtener_todas_membresias.py ===== 
import pytest
from decimal import Decimal

# ================================
# GET /api/membresias
# ================================

def test_obtener_todas_membresias_exitoso(monkeypatch, client, fake_conn):

    fake_conn.set_fetchall_responses([
        [
            {
                "id_membresia": 1,
                "nombre_membresia": "Bronce",
                "precio_membresia": Decimal("19.99"),
                "bv": Decimal("50")
            },
            {
                "id_membresia": 2,
                "nombre_membresia": "Plata",
                "precio_membresia": Decimal("39.99"),
                "bv": Decimal("120")
            }
        ]
    ])

    monkeypatch.setattr(
        "app.controllers.User.Personal.membresia.get_db",
        lambda: fake_conn
    )

    resp = client.get("/api/membresias")
    body = resp.get_json()

    assert resp.status_code == 200
    assert body["success"] is True
    assert isinstance(body["membresias"], list)
    assert isinstance(body["membresias"][0]["precio_membresia"], float)


def test_obtener_todas_membresias_error(monkeypatch, client):

    def fake_error():
        raise Exception("DB caída")

    monkeypatch.setattr(
        "app.controllers.User.Personal.membresia.get_db",
        fake_error
    )

    resp = client.get("/api/membresias")
    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
===== F:\HGW-Sena\HGW-Flask\tests\Personal\Red\test_mi_red.py ===== 
import pytest

DIR = "app.controllers.User.Personal.red_multinivel"

# -------------------------------------------------------
# 1. FALTA ID DE USUARIO
# -------------------------------------------------------
def test_obtener_mi_red_sin_id(client):
    resp = client.get("/api/mi-red")
    assert resp.status_code == 400
    assert resp.get_json()["success"] is False


# -------------------------------------------------------
# 2. ERROR EN CONEXIÓN MYSQL (connection = None)
# -------------------------------------------------------
def test_obtener_mi_red_sin_conexion(monkeypatch, client):
    monkeypatch.setattr(f"{DIR}.get_connection", lambda: None)

    resp = client.get("/api/mi-red?id=1")
    assert resp.status_code == 500

    data = resp.get_json()
    assert data["success"] is False
    assert "conexión" in data["message"].lower()


# -------------------------------------------------------
# 3. USUARIO NO EXISTE
# -------------------------------------------------------
def test_obtener_mi_red_usuario_no_existe(monkeypatch, client, fake_conn):

    # No retorna usuario
    fake_conn.set_fetchone_responses([None])
    fake_conn.set_fetchall_responses([])

    monkeypatch.setattr(f"{DIR}.get_connection", lambda: fake_conn)

    resp = client.get("/api/mi-red?id=99")

    assert resp.status_code == 404
    assert resp.get_json()["message"] == "Usuario no encontrado"


# -------------------------------------------------------
# 4. RED EXITOSA (devuelve descendientes)
# -------------------------------------------------------
def test_obtener_mi_red_exitoso(monkeypatch, client, fake_conn):

    # 1) fetchone() → usuario encontrado
    # 2) fetchall() → lista de la red
    fake_conn.set_fetchone_responses([
        {"nombre_usuario": "fabian"},  # usuario principal
    ])

    fake_conn.set_fetchall_responses([
        [   # red multinivel
            {
                "id_usuario": 2,
                "nombre": "Juan",
                "apellido": "Pérez",
                "nombre_usuario": "juan",
                "correo_electronico": "j@j.com",
                "url_foto_perfil": None,
                "patrocinador": "fabian",
                "nombre_membresia": "Bronce",
                "fecha_registro": "2024-01-01 10:00:00",
                "nivel": 1,
                "activo": 1,
                "numero_telefono": "123",
                "total_red": 3,
                "puntos_bv": 10
            }
        ]
    ])

    monkeypatch.setattr(f"{DIR}.get_connection", lambda: fake_conn)

    resp = client.get("/api/mi-red?id=1")

    assert resp.status_code == 200
    body = resp.get_json()

    assert body["success"] is True
    assert body["total"] == 1
    assert body["codigo_patrocinador"] == "fabian"
    assert body["red"][0]["nombre_usuario"] == "juan"


# -------------------------------------------------------
# 5. ERROR INTERNO EN CONSULTA
# -------------------------------------------------------
def test_obtener_mi_red_error(monkeypatch, client):

    class FakeConn:
        def cursor(self):
            raise Exception("DB caída")

    monkeypatch.setattr(f"{DIR}.get_connection", lambda: FakeConn())

    resp = client.get("/api/mi-red?id=1")

    assert resp.status_code == 500
    assert resp.get_json()["success"] is False
 
